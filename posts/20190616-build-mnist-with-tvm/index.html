<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Build MNIST with TVM</title>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://aben20807.github.io/index.xml">
  <link rel="canonical" href="https://aben20807.github.io/posts/20190616-build-mnist-with-tvm/">
  
  <link rel="shortcut icon" type="image/png" href="https://aben20807.github.io/apple-touch-icon-precomposed.png">
  
  
  <meta name="generator" content="Hugo 0.74.3" />

  
<meta name="og:title"
  content="Build MNIST with TVM" />
<meta name="og:type" content="article" />
<meta name="og:image" content="https://drive.google.com/uc?export=view&id=1qSdoAYPCxNk5tlI0ELivCieDWCQO9IOV" />
<meta name="og:description" content="" />
<meta name="og:url" content="https://aben20807.github.io/posts/20190616-build-mnist-with-tvm/" />
<meta name="og:site_name"
  content="Build MNIST with TVM" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@" />


  
  <script src="https://cdn.jsdelivr.net/npm/fetch-inject@2.0.4/dist/fetch-inject.umd.min.js"
    integrity="sha256-paKBtnIrL5ClLfBOtgxh1UqYCjL9790IRvDOnBh2LyI=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://aben20807.github.io/css/tachyons.min.css" async>
  
  <link rel="stylesheet" href="https://aben20807.github.io/css/story.css" async>
  
  <link rel="stylesheet" href="https://aben20807.github.io/css/hugouo.css" async>
  <link rel="stylesheet" href="https://aben20807.github.io/css/allinone.css" async>
  
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
    integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" async>
  <link
    href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i|Lora:400|Noto+Sans+TC:400,400i|Milonga:400|Roboto+Mono:400&amp;subset=latin-ext"
    rel="stylesheet" async>
  
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.1/lazysizes.min.js"></script>
  <noscript>
    <style type="text/css">
      .lazyload {
        display: none;
      }
    </style>
  </noscript>

  
  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123296010-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

<body
  class="ma0 bg-white section-posts page-kind-page is-page-true ">
  
  <header class="cover bg-top"
    style="background-image: url('https://drive.google.com/uc?export=view&amp;id=1qSdoAYPCxNk5tlI0ELivCieDWCQO9IOV'); background-position: center;"
    >
    <div class="bg-black-60 bb bt">

      <nav class="hide-print sans-serif  border-box pa3 ph5-l">
        <a href="https://aben20807.github.io/" title="Home">
          <img src="https://aben20807.github.io/img/logo.jpg" class="w2 h2 br-100" alt="記錄用" />
        </a>
        <div class="fr h2 pv2 tr">
          <a class="link f5 ml2 dim near-white no-underline-on-hover" href="/categories/">分類</a>
          <a class="link f5 ml2 dim near-white no-underline-on-hover" href="/tags/">標籤</a>
          <a class="link f5 ml2 dim near-white no-underline-on-hover" href="/about">關於</a>
          <a class="link f5 ml2 dim near-white no-underline-on-hover" href="https://github.com/aben20807/blog-post" target="_blank" rel="noreferrer noopener"><i class="fab fa-github-square"></i></a>
          <a class="link f5 ml2 dim near-white no-underline-on-hover" href="https://www.linkedin.com/in/po-hsuan-huang-6587b6117/" target="_blank" rel="noreferrer noopener"><i class="fab fa-linkedin"></i></a>
          <a class="link f5 ml2 dim near-white no-underline-on-hover" href="https://www.youtube.com/channel/UCEiQdnpoVJcaca7jWlPjEdw" target="_blank" rel="noreferrer noopener"><i class="fab fa-youtube-square"></i></a>
          <a class="link f5 ml2 dim near-white fas fa-rss-square no-underline-on-hover" href="https://aben20807.github.io/index.xml"
            title="RSS Feed"></a>
          <a class="link f5 ml2 dim near-white fas fa-envelope no-underline-on-hover" href="https://aben20807.github.io/subscription/"
            role="subscription" title="Subscription"></a>
          <a class="link f5 ml2 dim near-white fas fa-search no-underline-on-hover" href="https://aben20807.github.io/search/" role="search"
            title="Search"></a>
        </div>
      </nav>

      <div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
        <h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
          Build MNIST with TVM</h1>
        <h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
          
          
          
          Published
          <time datetime="2019-06-16T17:40:59&#43;08:00">Jun 16, 2019</time>
          <span class="display-print">by Huang Po-Hsuan</span>
           in <a
            href="https://aben20807.github.io/categories/%E6%B7%B1%E5%BA%A6%E5%AD%B8%E7%BF%92"
            class="no-underline category title-link near-white dim">深度學習</a>
          <span class="display-print">at https://aben20807.github.io/posts/20190616-build-mnist-with-tvm/</span>
          
          
        </h2>
      </div>

      
      
      
      

    </div>
  </header>
  
  <main role="main">
    
<div class="row bg-white">
  <div class="column col-1">
    <article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links" style="max-width:720px">
      
      <div class="row">
        <div class="col-md-8">
          
          <div class="mb-5">
            <div class="li-x div-x post-meta">
  <li class="pr-0"><a href="https://aben20807.github.io/tags/"><i class="fas fa-tags"></i></a></li>
  <div class="tags-sm">
    
    <li><a href="https://aben20807.github.io/tags/dnn" role="button" class="no-underline no-underline-on-hover">dnn </a></li>
    
    
    <li><a href="https://aben20807.github.io/tags/python" role="button" class="no-underline no-underline-on-hover">python </a></li>
    
    
    <li><a href="https://aben20807.github.io/tags/tvm" role="button" class="no-underline no-underline-on-hover">tvm </a></li>
    
    
    <li><a href="https://aben20807.github.io/tags/keras" role="button" class="no-underline no-underline-on-hover">keras </a></li>
    
    
    <li><a href="https://aben20807.github.io/tags/mnist" role="button" class="no-underline no-underline-on-hover">mnist </a></li>
    
    
  </div>
</div>

          </div>
          
        </div>
      </div>
      
<script src="https://code.iconify.design/1/1.0.0-rc6/iconify.min.js"></script>




































<!-- https://drive.google.com/uc?export=view&id= -->
<p>真的是隔很久&hellip;.藉口就不多說了 OuO</p>
<p>這篇主要在造輪子，主要原因就是幾乎找不到這類輪子了，而剛好自己需要，又卡了很久才完成，不如記錄一下 OuO</p>
<h1 id="前言" class="article-heading">前言<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#前言"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h1>
<p>最近在做 TVM 相關的事，它支援頗多前端，基於方便我就隨便挑一個 Keras 了 (先說我不會 AI @@<br>
然後因為現在頗多都在做 ImageNet 或更之後的應用，MNIST 的資料反而偏少，尤其是幾乎找不到訓練好的模型，說幾乎是因為還真的被我找到，傳送門：<a href="https://github.com/EN10/KerasMNIST" target="_blank" rel="noreferrer noopener">EN10/KerasMNIST</a>，如果只是要用 Keras 來操作 MNIST 的話可以用這個連結，我已經確認過是可以直接執行XDD</p>
<hr>
<p>2019.06.17 更新：扯，原來官網就有&hellip;.https://keras.io/examples/mnist_cnn/<br>
然後我發現我整篇都把 MNIST 打成 MINST&hellip;.</p>
<hr>
<p>話說原本以為模型被存成檔案的話只有權重，結果是有兩種，也可以跟整個模型存在一起，詳情就去 Keras 官網 <a href="https://keras.io/getting-started/faq/#how-can-i-save-a-keras-model" target="_blank" rel="noreferrer noopener">How can I save a Keras model?</a> 看看吧。</p>
<p>所以上面那個做 MNIST 的是把整個模型存起來，這主要不是我要的＠＠，不過還是先用看看。</p>
<p>P.S. 一些相依性檔案例如 Keras, Tensorflow, TVM 的安裝就不一一記錄囉 OuO</p>
<h1 id="環境" class="article-heading">環境<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#環境"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h1>
<ul>
<li>ubuntu 18.04</li>
<li>TVM 0.6.dev (6a4d71ff40915611bd42b62994992b879e6be610)</li>
</ul>
<h1 id="一堆程式碼上菜囉" class="article-heading">一堆程式碼上菜囉<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#一堆程式碼上菜囉"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h1>
<h2 id="原始-cnnpredictpy" class="article-heading">原始 <code>cnnPredict.py</code><a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#原始-cnnpredictpy"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<p>注意要下載或複製那個程式碼，<code>cnn.h5</code> 跟 <code>test3.png</code> 一樣要放對位置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> scipy.misc <span style="color:#f92672">import</span> imread, imresize
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
x <span style="color:#f92672">=</span> imread(<span style="color:#e6db74">&#39;test3.png&#39;</span>,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;L&#39;</span>)
<span style="color:#75715e"># Compute a bit-wise inversion so black becomes white and vice versa</span>
x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>invert(x)
<span style="color:#75715e"># Make it the right size</span>
x <span style="color:#f92672">=</span> imresize(x,(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>))
<span style="color:#75715e"># Convert to a 4D tensor to feed into our model</span>
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>

<span style="color:#75715e"># Perform the prediction</span>
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> load_model
model <span style="color:#f92672">=</span> load_model(<span style="color:#e6db74">&#39;cnn.h5&#39;</span>)
out <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(x)
<span style="color:#66d9ef">print</span>(np<span style="color:#f92672">.</span>argmax(out))
</code></pre></div><p>很好，可以執行～</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 cnnPredict.py
<span style="color:#ae81ff">3</span>
</code></pre></div><h2 id="加入-tvm-囉" class="article-heading">加入 TVM 囉<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#加入-tvm-囉"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> nnvm
<span style="color:#f92672">import</span> tvm
<span style="color:#f92672">import</span> tvm.relay <span style="color:#f92672">as</span> relay
<span style="color:#f92672">from</span> scipy.misc <span style="color:#f92672">import</span> imread, imresize
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> load_model

x <span style="color:#f92672">=</span> imread(<span style="color:#e6db74">&#39;test3.png&#39;</span>,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;L&#39;</span>)
<span style="color:#75715e"># Compute a bit-wise inversion so black becomes white and vice versa</span>
x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>invert(x)
<span style="color:#75715e"># Make it the right size</span>
x <span style="color:#f92672">=</span> imresize(x,(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>))
<span style="color:#75715e"># Convert to a 4D tensor to feed into our model</span>
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>

<span style="color:#75715e"># Load model from pre-trained file</span>
model <span style="color:#f92672">=</span> load_model(<span style="color:#e6db74">&#39;cnn.h5&#39;</span>)

<span style="color:#75715e"># Compile with tvm</span>
shape_dict <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;input_1&#39;</span>: (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>)}
func, params <span style="color:#f92672">=</span> relay<span style="color:#f92672">.</span>frontend<span style="color:#f92672">.</span>from_keras(model, shape_dict)
target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm&#34;</span>
ctx <span style="color:#f92672">=</span> tvm<span style="color:#f92672">.</span>cpu(<span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">with</span> relay<span style="color:#f92672">.</span>build_config(opt_level<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
    executor <span style="color:#f92672">=</span> relay<span style="color:#f92672">.</span>build_module<span style="color:#f92672">.</span>create_executor(<span style="color:#e6db74">&#39;graph&#39;</span>, func, ctx, target)

<span style="color:#75715e"># Perform the prediction</span>
dtype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;float32&#39;</span>
tvm_out <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span>evaluate(func)(tvm<span style="color:#f92672">.</span>nd<span style="color:#f92672">.</span>array(x<span style="color:#f92672">.</span>astype(dtype)), <span style="color:#f92672">**</span>params)
<span style="color:#66d9ef">print</span>(np<span style="color:#f92672">.</span>argmax(tvm_out<span style="color:#f92672">.</span>asnumpy()[<span style="color:#ae81ff">0</span>]))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 cnnPredict_tvm.py
In <span style="color:#e6db74">`</span>main<span style="color:#e6db74">`</span>: 
v0.0.1
fn <span style="color:#f92672">(</span>%conv2d_1_input, %v_param_1: Tensor<span style="color:#f92672">[(</span>32, 1, 3, 3<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_2: Tensor<span style="color:#f92672">[(</span>32,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_3: Tensor<span style="color:#f92672">[(</span>64, 32, 3, 3<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_4: Tensor<span style="color:#f92672">[(</span>64,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_5: Tensor<span style="color:#f92672">[(</span>128, 9216<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_6: Tensor<span style="color:#f92672">[(</span>128,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_7: Tensor<span style="color:#f92672">[(</span>10, 128<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_8: Tensor<span style="color:#f92672">[(</span>10,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
  %0 <span style="color:#f92672">=</span> nn.conv2d<span style="color:#f92672">(</span>%conv2d_1_input, %v_param_1, channels<span style="color:#f92672">=</span>32, kernel_size<span style="color:#f92672">=[</span>3, 3<span style="color:#f92672">])</span>
  %1 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%0, %v_param_2<span style="color:#f92672">)</span>
  %2 <span style="color:#f92672">=</span> nn.relu<span style="color:#f92672">(</span>%1<span style="color:#f92672">)</span>
  %3 <span style="color:#f92672">=</span> nn.conv2d<span style="color:#f92672">(</span>%2, %v_param_3, channels<span style="color:#f92672">=</span>64, kernel_size<span style="color:#f92672">=[</span>3, 3<span style="color:#f92672">])</span>
  %4 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%3, %v_param_4<span style="color:#f92672">)</span>
  %5 <span style="color:#f92672">=</span> nn.relu<span style="color:#f92672">(</span>%4<span style="color:#f92672">)</span>
  %6 <span style="color:#f92672">=</span> nn.max_pool2d<span style="color:#f92672">(</span>%5, pool_size<span style="color:#f92672">=[</span>2, 2<span style="color:#f92672">]</span>, strides<span style="color:#f92672">=[</span>2, 2<span style="color:#f92672">])</span>an internal invariant was violated <span style="color:#66d9ef">while</span> typechecking your program <span style="color:#f92672">[</span>22:05:21<span style="color:#f92672">]</span> tvm/src/relay/op/nn/pooling.cc:73: Check failed: data !<span style="color:#f92672">=</span> nullptr: 
; 
  %7 <span style="color:#f92672">=</span> transpose<span style="color:#f92672">(</span>%6, axes<span style="color:#f92672">=[</span>0, 2, 3, 1<span style="color:#f92672">])</span>
  %8 <span style="color:#f92672">=</span> nn.batch_flatten<span style="color:#f92672">(</span>%7<span style="color:#f92672">)</span>
  %9 <span style="color:#f92672">=</span> nn.dense<span style="color:#f92672">(</span>%8, %v_param_5, units<span style="color:#f92672">=</span>128<span style="color:#f92672">)</span>
  %10 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%9, %v_param_6<span style="color:#f92672">)</span>
  %11 <span style="color:#f92672">=</span> nn.relu<span style="color:#f92672">(</span>%10<span style="color:#f92672">)</span>
  %12 <span style="color:#f92672">=</span> nn.dense<span style="color:#f92672">(</span>%11, %v_param_7, units<span style="color:#f92672">=</span>10<span style="color:#f92672">)</span>
  %13 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%12, %v_param_8<span style="color:#f92672">)</span>
  nn.softmax<span style="color:#f92672">(</span>%13, axis<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>扯，竟然不行＠＠，而且完全不知道錯哪，找了一些資料說是 shape 錯了，我試了各種排列組合也都不行&hellip;.</p>
<h2 id="只存-mnist-的權重" class="article-heading">只存 MNIST 的權重<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#只存-mnist-的權重"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<p>只好使用上面提到 Keras 官網 <a href="https://keras.io/getting-started/faq/#how-can-i-save-a-keras-model" target="_blank" rel="noreferrer noopener">How can I save a Keras model?</a> 的方式只存權重出來，這裡我們只需要改最後一行，<code>save</code> 改成 <code>save_weights</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.datasets <span style="color:#f92672">import</span> mnist
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense, Dropout, Flatten
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Conv2D, MaxPooling2D
<span style="color:#f92672">from</span> keras <span style="color:#f92672">import</span> backend <span style="color:#66d9ef">as</span> K

batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
num_classes <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>

<span style="color:#75715e"># input image dimensions</span>
img_rows, img_cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>

<span style="color:#75715e"># the data, shuffled and split between train and test sets</span>
(x_train, y_train), (x_test, y_test) <span style="color:#f92672">=</span> mnist<span style="color:#f92672">.</span>load_data()

x_train <span style="color:#f92672">=</span> x_train<span style="color:#f92672">.</span>reshape(x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], img_rows, img_cols, <span style="color:#ae81ff">1</span>)
x_test <span style="color:#f92672">=</span> x_test<span style="color:#f92672">.</span>reshape(x_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], img_rows, img_cols, <span style="color:#ae81ff">1</span>)
input_shape <span style="color:#f92672">=</span> (img_rows, img_cols, <span style="color:#ae81ff">1</span>)

x_train <span style="color:#f92672">=</span> x_train<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x_test <span style="color:#f92672">=</span> x_test<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x_train <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>
x_test <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;x_train shape:&#39;</span>, x_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;train samples&#39;</span>)
<span style="color:#66d9ef">print</span>(x_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;test samples&#39;</span>)

<span style="color:#75715e"># convert class vectors to binary class matrices</span>
y_train <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>to_categorical(y_train, num_classes)
y_test <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>to_categorical(y_test, num_classes)

model <span style="color:#f92672">=</span> Sequential()
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>),
                 activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>,
                 input_shape<span style="color:#f92672">=</span>input_shape))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
model<span style="color:#f92672">.</span>add(Dense(num_classes, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>))

model<span style="color:#f92672">.</span>compile(loss<span style="color:#f92672">=</span>keras<span style="color:#f92672">.</span>losses<span style="color:#f92672">.</span>categorical_crossentropy,
              optimizer<span style="color:#f92672">=</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adadelta(),
              metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>])

model<span style="color:#f92672">.</span>fit(x_train, y_train,
          batch_size<span style="color:#f92672">=</span>batch_size,
          epochs<span style="color:#f92672">=</span>epochs,
          verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
          validation_data<span style="color:#f92672">=</span>(x_test, y_test))
score <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>evaluate(x_test, y_test, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test loss:&#39;</span>, score[<span style="color:#ae81ff">0</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test accuracy:&#39;</span>, score[<span style="color:#ae81ff">1</span>])
model<span style="color:#f92672">.</span>save_weights(<span style="color:#e6db74">&#39;mnist_weights.h5&#39;</span>)
</code></pre></div><p>跑了頗久，不過跟其應該比 ImageNet 快很多了。結果如下圖。

  <figure class="gphoto-media center">
    <div class="img-container center" style="width:73%;">
      <noscript>
        <img src="https://drive.google.com/uc?export=view&id=1qSdoAYPCxNk5tlI0ELivCieDWCQO9IOV" class="center img-zoomable" alt="train a MNIST model with Keras" data-action="zoom" title="">
      </noscript>
      <img data-src="https://drive.google.com/uc?export=view&id=1qSdoAYPCxNk5tlI0ELivCieDWCQO9IOV" class="center img-zoomable lazyload" alt="train a MNIST model with Keras" data-action="zoom" title="">
    </div>
    <figcaption>
      <center class="caption-text">
        <p style="margin: .7rem 0 0;">train a MNIST model with Keras</p>
        <!-- hide the link -->
        <font class="douyin hover-show">
          <a href="https://drive.google.com/open?id=1qSdoAYPCxNk5tlI0ELivCieDWCQO9IOV" target="_blank" rel="noreferrer noopener" style="opacity: 1.0; text-decoration: none;" >OuO</a>
        </font>
      </center>
    </figcaption>
  </figure>
</p>
<h2 id="自己用-keras-建構一個-mnist-再餵給-tvm" class="article-heading">自己用 Keras 建構一個 MNIST 再餵給 TVM<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#自己用-keras-建構一個-mnist-再餵給-tvm"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<p>把上面產生的權重餵給自己建構的模型</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> nnvm
<span style="color:#f92672">import</span> tvm
<span style="color:#f92672">import</span> tvm.relay <span style="color:#f92672">as</span> relay
<span style="color:#f92672">from</span> scipy.misc <span style="color:#f92672">import</span> imread, imresize
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> load_model
<span style="color:#f92672">from</span> keras.datasets <span style="color:#f92672">import</span> mnist
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense, Dropout, Flatten, InputLayer
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Conv2D, MaxPooling2D
num_classes <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>

x <span style="color:#f92672">=</span> imread(<span style="color:#e6db74">&#39;test3.png&#39;</span>,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;L&#39;</span>)
<span style="color:#75715e"># Compute a bit-wise inversion so black becomes white and vice versa</span>
x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>invert(x)
<span style="color:#75715e"># Make it the right size</span>
x <span style="color:#f92672">=</span> imresize(x,(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>))
<span style="color:#75715e"># Convert to a 4D tensor to feed into our model</span>
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>

<span style="color:#75715e"># Construct a MNIST model</span>
model <span style="color:#f92672">=</span> Sequential()
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
model<span style="color:#f92672">.</span>add(Dense(num_classes, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>))

<span style="color:#75715e"># Load the weights that we get from last program</span>
model<span style="color:#f92672">.</span>load_weights(<span style="color:#e6db74">&#39;mnist_weights.h5&#39;</span>)

shape_dict <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;input_1&#39;</span>: (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>)}
func, params <span style="color:#f92672">=</span> relay<span style="color:#f92672">.</span>frontend<span style="color:#f92672">.</span>from_keras(model, shape_dict)
target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm&#34;</span>
ctx <span style="color:#f92672">=</span> tvm<span style="color:#f92672">.</span>cpu(<span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">with</span> relay<span style="color:#f92672">.</span>build_config(opt_level<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
    executor <span style="color:#f92672">=</span> relay<span style="color:#f92672">.</span>build_module<span style="color:#f92672">.</span>create_executor(<span style="color:#e6db74">&#39;graph&#39;</span>, func, ctx, target)

<span style="color:#75715e"># Perform the prediction</span>
dtype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;float32&#39;</span>
tvm_out <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span>evaluate(func)(tvm<span style="color:#f92672">.</span>nd<span style="color:#f92672">.</span>array(x<span style="color:#f92672">.</span>astype(dtype)), <span style="color:#f92672">**</span>params)
<span style="color:#66d9ef">print</span>(np<span style="color:#f92672">.</span>argmax(tvm_out<span style="color:#f92672">.</span>asnumpy()[<span style="color:#ae81ff">0</span>]))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 cnnPredict_tvm.py
In <span style="color:#e6db74">`</span>main<span style="color:#e6db74">`</span>: 
v0.0.1
fn <span style="color:#f92672">(</span>%conv2d_1_input, %v_param_1: Tensor<span style="color:#f92672">[(</span>32, 1, 3, 3<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_2: Tensor<span style="color:#f92672">[(</span>32,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_3: Tensor<span style="color:#f92672">[(</span>64, 32, 3, 3<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_4: Tensor<span style="color:#f92672">[(</span>64,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_5: Tensor<span style="color:#f92672">[(</span>128, 9216<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_6: Tensor<span style="color:#f92672">[(</span>128,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_7: Tensor<span style="color:#f92672">[(</span>10, 128<span style="color:#f92672">)</span>, float32<span style="color:#f92672">]</span>, %v_param_8: Tensor<span style="color:#f92672">[(</span>10,<span style="color:#f92672">)</span>, float32<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
  %0 <span style="color:#f92672">=</span> nn.conv2d<span style="color:#f92672">(</span>%conv2d_1_input, %v_param_1, channels<span style="color:#f92672">=</span>32, kernel_size<span style="color:#f92672">=[</span>3, 3<span style="color:#f92672">])</span>
  %1 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%0, %v_param_2<span style="color:#f92672">)</span>
  %2 <span style="color:#f92672">=</span> nn.relu<span style="color:#f92672">(</span>%1<span style="color:#f92672">)</span>
  %3 <span style="color:#f92672">=</span> nn.conv2d<span style="color:#f92672">(</span>%2, %v_param_3, channels<span style="color:#f92672">=</span>64, kernel_size<span style="color:#f92672">=[</span>3, 3<span style="color:#f92672">])</span>
  %4 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%3, %v_param_4<span style="color:#f92672">)</span>
  %5 <span style="color:#f92672">=</span> nn.relu<span style="color:#f92672">(</span>%4<span style="color:#f92672">)</span>
  %6 <span style="color:#f92672">=</span> nn.max_pool2d<span style="color:#f92672">(</span>%5, pool_size<span style="color:#f92672">=[</span>2, 2<span style="color:#f92672">]</span>, strides<span style="color:#f92672">=[</span>2, 2<span style="color:#f92672">])</span>an internal invariant was violated <span style="color:#66d9ef">while</span> typechecking your program <span style="color:#f92672">[</span>22:21:27<span style="color:#f92672">]</span> tvm/src/relay/op/nn/pooling.cc:73: Check failed: data !<span style="color:#f92672">=</span> nullptr: 
; 
  %7 <span style="color:#f92672">=</span> transpose<span style="color:#f92672">(</span>%6, axes<span style="color:#f92672">=[</span>0, 2, 3, 1<span style="color:#f92672">])</span>
  %8 <span style="color:#f92672">=</span> nn.batch_flatten<span style="color:#f92672">(</span>%7<span style="color:#f92672">)</span>
  %9 <span style="color:#f92672">=</span> nn.dense<span style="color:#f92672">(</span>%8, %v_param_5, units<span style="color:#f92672">=</span>128<span style="color:#f92672">)</span>
  %10 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%9, %v_param_6<span style="color:#f92672">)</span>
  %11 <span style="color:#f92672">=</span> nn.relu<span style="color:#f92672">(</span>%10<span style="color:#f92672">)</span>
  %12 <span style="color:#f92672">=</span> nn.dense<span style="color:#f92672">(</span>%11, %v_param_7, units<span style="color:#f92672">=</span>10<span style="color:#f92672">)</span>
  %13 <span style="color:#f92672">=</span> nn.bias_add<span style="color:#f92672">(</span>%12, %v_param_8<span style="color:#f92672">)</span>
  nn.softmax<span style="color:#f92672">(</span>%13, axis<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>扯，結果竟然一模一樣。</p>
<h2 id="檢驗剛剛建立的模型是否正確" class="article-heading">檢驗剛剛建立的模型是否正確<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#檢驗剛剛建立的模型是否正確"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<p>總之先試試看是不是跟直接讀 <code>cnn.h5</code> 一樣。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> nnvm
<span style="color:#f92672">import</span> tvm
<span style="color:#f92672">import</span> tvm.relay <span style="color:#f92672">as</span> relay
<span style="color:#f92672">from</span> scipy.misc <span style="color:#f92672">import</span> imread, imresize
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> load_model
<span style="color:#f92672">from</span> keras.datasets <span style="color:#f92672">import</span> mnist
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense, Dropout, Flatten, InputLayer
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Conv2D, MaxPooling2D
num_classes <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>

x <span style="color:#f92672">=</span> imread(<span style="color:#e6db74">&#39;test3.png&#39;</span>,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;L&#39;</span>)
<span style="color:#75715e"># Compute a bit-wise inversion so black becomes white and vice versa</span>
x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>invert(x)
<span style="color:#75715e"># Make it the right size</span>
x <span style="color:#f92672">=</span> imresize(x,(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>))
<span style="color:#75715e"># Convert to a 4D tensor to feed into our model</span>
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>

<span style="color:#75715e"># Construct a MNIST model</span>
model <span style="color:#f92672">=</span> Sequential()
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
model<span style="color:#f92672">.</span>add(Dense(num_classes, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>))

<span style="color:#75715e"># Load the weights that we get from last program</span>
model<span style="color:#f92672">.</span>load_weights(<span style="color:#e6db74">&#39;mnist_weights.h5&#39;</span>)

<span style="color:#75715e"># Perform the prediction</span>
out <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(x)
<span style="color:#66d9ef">print</span>(np<span style="color:#f92672">.</span>argmax(out))
</code></pre></div><p>很好，是一樣&hellip;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 cnnPredict.py
<span style="color:#ae81ff">3</span>
</code></pre></div><h2 id="突破加個輸入層" class="article-heading">突破，加個輸入層？<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#突破加個輸入層"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<p>在找解決方式的過程中突然看到<a href="https://stackoverflow.com/a/49600827/6734174" target="_blank" rel="noreferrer noopener">這裡</a>提到有 <code>InputLayer</code>，不如加看看。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> nnvm
<span style="color:#f92672">import</span> tvm
<span style="color:#f92672">import</span> tvm.relay <span style="color:#f92672">as</span> relay
<span style="color:#f92672">from</span> scipy.misc <span style="color:#f92672">import</span> imread, imresize
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> load_model
<span style="color:#f92672">from</span> keras.datasets <span style="color:#f92672">import</span> mnist
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense, Dropout, Flatten, InputLayer
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Conv2D, MaxPooling2D
num_classes <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
input_shape <span style="color:#f92672">=</span> (<span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>)

x <span style="color:#f92672">=</span> imread(<span style="color:#e6db74">&#39;test3.png&#39;</span>,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;L&#39;</span>)
<span style="color:#75715e"># Compute a bit-wise inversion so black becomes white and vice versa</span>
x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>invert(x)
<span style="color:#75715e"># Make it the right size</span>
x <span style="color:#f92672">=</span> imresize(x,(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>))
<span style="color:#75715e"># Convert to a 4D tensor to feed into our model</span>
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>)
x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>

<span style="color:#75715e"># model = load_model(&#39;cnn.h5&#39;)</span>
<span style="color:#75715e"># Construct a MNIST model</span>
model <span style="color:#f92672">=</span> Sequential()
model<span style="color:#f92672">.</span>add(InputLayer(input_shape<span style="color:#f92672">=</span>input_shape))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>input_shape))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
model<span style="color:#f92672">.</span>add(Dense(num_classes, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>))

<span style="color:#75715e"># Load the weights that we get from last program</span>
model<span style="color:#f92672">.</span>load_weights(<span style="color:#e6db74">&#39;mnist_weights.h5&#39;</span>)

shape_dict <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;input_1&#39;</span>: (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>)}
func, params <span style="color:#f92672">=</span> relay<span style="color:#f92672">.</span>frontend<span style="color:#f92672">.</span>from_keras(model, shape_dict)
target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm&#34;</span>
ctx <span style="color:#f92672">=</span> tvm<span style="color:#f92672">.</span>cpu(<span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">with</span> relay<span style="color:#f92672">.</span>build_config(opt_level<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
    executor <span style="color:#f92672">=</span> relay<span style="color:#f92672">.</span>build_module<span style="color:#f92672">.</span>create_executor(<span style="color:#e6db74">&#39;graph&#39;</span>, func, ctx, target)

<span style="color:#75715e"># Pperform the prediction</span>
dtype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;float32&#39;</span>
tvm_out <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span>evaluate(func)(tvm<span style="color:#f92672">.</span>nd<span style="color:#f92672">.</span>array(x<span style="color:#f92672">.</span>astype(dtype)), <span style="color:#f92672">**</span>params)
<span style="color:#66d9ef">print</span>(np<span style="color:#f92672">.</span>argmax(tvm_out<span style="color:#f92672">.</span>asnumpy()[<span style="color:#ae81ff">0</span>]))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 test_mnist.py
<span style="color:#ae81ff">3</span>
</code></pre></div><p>扯，竟然過了 QuQ</p>
<h1 id="其他" class="article-heading">其他<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#其他"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h1>
<h2 id="lutzroedernetronhttpsgithubcomlutzroedernetron" class="article-heading"><a href="https://github.com/lutzroeder/netron" target="_blank" rel="noreferrer noopener"><code>lutzroeder/netron</code></a><a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#lutzroedernetronhttpsgithubcomlutzroedernetron"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<p>發現了一個視覺化工具可以看模型。

  <figure class="gphoto-media center">
    <div class="img-container center" style="width:73%;">
      <noscript>
        <img src="https://drive.google.com/uc?export=view&id=18rjO-BiQTXRsSDAtisBkyEEhkO2sIBoP" class="center img-zoomable" alt="NETRON" data-action="zoom" title="">
      </noscript>
      <img data-src="https://drive.google.com/uc?export=view&id=18rjO-BiQTXRsSDAtisBkyEEhkO2sIBoP" class="center img-zoomable lazyload" alt="NETRON" data-action="zoom" title="">
    </div>
    <figcaption>
      <center class="caption-text">
        <p style="margin: .7rem 0 0;">NETRON</p>
        <!-- hide the link -->
        <font class="douyin hover-show">
          <a href="https://drive.google.com/open?id=18rjO-BiQTXRsSDAtisBkyEEhkO2sIBoP" target="_blank" rel="noreferrer noopener" style="opacity: 1.0; text-decoration: none;" >OuO</a>
        </font>
      </center>
    </figcaption>
  </figure>
</p>
<h2 id="想看中間的-shape-的話" class="article-heading">想看中間的 shape 的話<a class="headline-hash smoothScroll hover-show scrollspy" style="font-size: 0.75em; color: black; padding-left: 0.25em" href="#想看中間的-shape-的話"><span class="iconify" data-icon="octicon-link" data-inline="false"></span></a> </h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">for</span> layer <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>layers:
    <span style="color:#66d9ef">print</span>(layer<span style="color:#f92672">.</span>input_shape)
    <span style="color:#66d9ef">print</span>(layer<span style="color:#f92672">.</span>input)
    <span style="color:#66d9ef">print</span>(layer<span style="color:#f92672">.</span>output_shape)
    <span style="color:#66d9ef">print</span>(layer<span style="color:#f92672">.</span>output)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;---&#34;</span>)
</code></pre></div>
      Last modified: Aug 9, 2019
      <div class="row">
        
<script type="text/javascript">
  document.write("<iframe scrolling='no' frameborder='0' class='center' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='' src='https://button.like.co/in/embed/aben20807/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");
</script>
      </div>
      
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "forrecording" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>
  </div><div id="toc" class="column col-2">


<div class="toc toc-nav toc-pills ml-0 col-3">
  <li class="nav-item pb-3 text-center">
    <span class="font-weight-bold mb-2">- CATALOG - </span>
  </li>
  <div id="toc-scroll" class="noselect hide-scrollbar"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e5%89%8d%e8%a8%80">
          前言
        </a>
      </li>
      </ul><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e7%92%b0%e5%a2%83">
          環境
        </a>
      </li>
      </ul><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e4%b8%80%e5%a0%86%e7%a8%8b%e5%bc%8f%e7%a2%bc%e4%b8%8a%e8%8f%9c%e5%9b%89">
          一堆程式碼上菜囉
        </a>
      </li>
      </ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e5%8e%9f%e5%a7%8b-cnnpredictpy">
          原始 cnnPredict.py
        </a>
      </li>
      </ul></ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e5%8a%a0%e5%85%a5-tvm-%e5%9b%89">
          加入 TVM 囉
        </a>
      </li>
      </ul></ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e5%8f%aa%e5%ad%98-mnist-%e7%9a%84%e6%ac%8a%e9%87%8d">
          只存 MNIST 的權重
        </a>
      </li>
      </ul></ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e8%87%aa%e5%b7%b1%e7%94%a8-keras-%e5%bb%ba%e6%a7%8b%e4%b8%80%e5%80%8b-mnist-%e5%86%8d%e9%a4%b5%e7%b5%a6-tvm">
          自己用 Keras 建構一個 MNIST 再餵給 TVM
        </a>
      </li>
      </ul></ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e6%aa%a2%e9%a9%97%e5%89%9b%e5%89%9b%e5%bb%ba%e7%ab%8b%e7%9a%84%e6%a8%a1%e5%9e%8b%e6%98%af%e5%90%a6%e6%ad%a3%e7%a2%ba">
          檢驗剛剛建立的模型是否正確
        </a>
      </li>
      </ul></ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e7%aa%81%e7%a0%b4%e5%8a%a0%e5%80%8b%e8%bc%b8%e5%85%a5%e5%b1%a4">
          突破，加個輸入層？
        </a>
      </li>
      </ul></ul><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e5%85%b6%e4%bb%96">
          其他
        </a>
      </li>
      </ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#lutzroedernetronhttpsgithubcomlutzroedernetron">
          lutzroeder/netron
        </a>
      </li>
      </ul></ul><ul class="toc"><ul class="toc"><li class="toc-item">
        <a class="toc-link smoothScroll" href="#%e6%83%b3%e7%9c%8b%e4%b8%ad%e9%96%93%e7%9a%84-shape-%e7%9a%84%e8%a9%b1">
          想看中間的 shape 的話
        </a>
      </li>
      </ul></ul></div>
  <ul class='toc'>
    <li class='toc-item'>
  <a class='goto pl1 toc-item' id='gotop'>⊛ Back to top</a>
</li>
<li class='toc-item'>
  <a class='goto pl1 toc-item' id='gobottom'>⊛ Go to bottom</a>
</li>
<script type='text/javascript'>
  fetchInject([
    "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
  ]).then(() => {
    
    var url = "https://cdnjs.cloudflare.com/ajax/libs/jquery-smooth-scroll/2.2.0/jquery.smooth-scroll.min.js";
    $.getScript(url, function () {
      $("#gotop").click(function (event) {
        $('html,body').animate({ scrollTop: 0 }, 300, 'swing', function () {
          $('a.toc-link').removeClass('active');
        });
      });
      $("#gobottom").click(function (event) {
        $('html,body').animate({ scrollTop: $(document).height() }, 300, 'swing', function () {
          $('a.toc-link').removeClass('active');
        });
      });
    });
  });
</script>
  </ul>
</div></div></div>

  </main>
  
  
  
  
  
  <footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3 db overflow-auto"
    role="contentinfo">
    <p class="w-50 fr tr" style="font-size:0.875rem !important;">
      Made with Hugo and
      <a class="no-underline no-underline-on-hover" href='https://github.com/aben20807/hugOuO' target="_blank" rel="noreferrer noopener">hugOuO</a>
    </p>
    <p class="w-50 near-white" style="font-size:0.875rem !important;">
      &copy; 2019-2020 Huang Po-Hsuan
    </p>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://aben20807.github.io/js/hugouo.js" async></script>
  <script src="https://aben20807.github.io/js/story.js" async></script>
  
  <script>
    fetchInject([
      "https://cdn.jsdelivr.net/npm/baffle@0.3.6/dist/baffle.min.js"
    ]).then(() => {
      baffle(document.querySelector('h1')).start().set({
        speed: 70,
      }).reveal(1000, 1000);
    });
  </script>

  
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
      inlineMath: [['$','$']],
      displayMath: [['$$','$$']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
          extensions: ["AMSmath.js", "AMSsymbols.js"] }
      }
    });
  </script>

  
  <script src="https://unpkg.com/zooming/build/zooming.min.js"></script>
  <script>
    
    document.addEventListener('DOMContentLoaded', function () {
      new Zooming({
        bgColor: 'rgb(0, 0, 0)', bgOpacity: '0.8', customSize: '200%', enableGrab: false
      }).listen('.img-zoomable')
    })
  </script>
  
  
</body>

</html>
