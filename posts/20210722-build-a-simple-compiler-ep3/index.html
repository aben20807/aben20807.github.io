<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Build a Simple Compiler Ep3</title><link rel=alternate type=application/rss+xml title=RSS href=https://aben20807.github.io/index.xml><link rel=canonical href=https://aben20807.github.io/posts/20210722-build-a-simple-compiler-ep3/><link rel="shortcut icon" type=image/png href=https://aben20807.github.io/apple-touch-icon-precomposed.png><meta name=generator content="Hugo 0.80.0"><meta name=og:title content="Build a Simple Compiler Ep3"><meta name=og:type content="article"><meta name=og:image content="https://images.unsplash.com/photo-1534631615537-d8f2af94b6ae?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1650&q=80"><meta name=og:description content><meta name=og:url content="https://aben20807.github.io/posts/20210722-build-a-simple-compiler-ep3/"><meta name=og:site_name content="Build a Simple Compiler Ep3"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@"><script src=https://cdn.jsdelivr.net/npm/fetch-inject@2.0.4/dist/fetch-inject.umd.min.js integrity="sha256-paKBtnIrL5ClLfBOtgxh1UqYCjL9790IRvDOnBh2LyI=" crossorigin=anonymous></script><link rel=stylesheet href=https://aben20807.github.io/css/tachyons.min.css async><link rel=stylesheet href=https://aben20807.github.io/css/story.css async><link rel=stylesheet href=https://aben20807.github.io/css/hugouo.css async><link rel=stylesheet href=https://aben20807.github.io/css/allinone.css async><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous async><link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i|Lora:400|Noto+Sans+TC:400,400i|Milonga:400|Roboto+Mono:500&subset=latin-ext" rel=stylesheet async><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.1/lazysizes.min.js></script><noscript><style type=text/css>.lazyload{display:none}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-123296010-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="ma0 bg-white section-posts page-kind-page is-page-true"><header class="cover bg-top" style="background-image:url(https://images.unsplash.com/photo-1534631615537-d8f2af94b6ae?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1650&q=80);background-position:50%"><div class="bg-black-60 bb bt"><nav class="hide-print sans-serif border-box pa3 ph5-l"><a href=https://aben20807.github.io/ title=Home><img src=https://aben20807.github.io/img/logo.jpg class="w2 h2 br-100" alt=記錄用></a><div class="fr h2 pv2 tr"><a class="link f5 ml2 dim near-white no-underline-on-hover" href=/categories/>分類</a>
<a class="link f5 ml2 dim near-white no-underline-on-hover" href=/tags/>標籤</a>
<a class="link f5 ml2 dim near-white no-underline-on-hover" href=/about>關於</a>
<a class="link f5 ml2 dim near-white no-underline-on-hover" href=https://github.com/aben20807/blog-post target=_blank rel="noreferrer noopener"><i class="fab fa-github-square"></i></a><a class="link f5 ml2 dim near-white no-underline-on-hover" href=https://www.linkedin.com/in/po-hsuan-huang-6587b6117/ target=_blank rel="noreferrer noopener"><i class="fab fa-linkedin"></i></a><a class="link f5 ml2 dim near-white no-underline-on-hover" href=https://www.youtube.com/channel/UCEiQdnpoVJcaca7jWlPjEdw target=_blank rel="noreferrer noopener"><i class="fab fa-youtube-square"></i></a><a class="link f5 ml2 dim near-white fas fa-rss-square no-underline-on-hover" href=https://aben20807.github.io/index.xml title="RSS Feed"></a><a class="link f5 ml2 dim near-white fas fa-envelope no-underline-on-hover" href=https://aben20807.github.io/subscription/ role=subscription title=Subscription></a><a class="link f5 ml2 dim near-white fas fa-search no-underline-on-hover" href=https://aben20807.github.io/search/ role=search title=Search></a></div></nav><div id=hdr class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns"><h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Build a Simple Compiler Ep3</h1><h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">Published
<time datetime=2021-07-22T20:17:52+08:00>Jul 22, 2021</time>
<span class=display-print>by Huang Po-Hsuan</span>
in <a href=https://aben20807.github.io/categories/%E7%B7%A8%E8%AD%AF%E5%99%A8 class="no-underline category title-link near-white dim">編譯器</a>
<span class=display-print>at https://aben20807.github.io/posts/20210722-build-a-simple-compiler-ep3/</span></h2></div><div class="w-100 cf hide-print"><a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href=https://unsplash.com/photos/sZ9JQScjFfA title="Photo Credit"></a></div></div></header><main role=main><div class="row bg-white"><div class="column col-1 printable"><article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links" style=max-width:720px><div class=row><div class=col-md-8><div class=mb-5><div class="li-x div-x post-meta"><li class=pr-0><a href=https://aben20807.github.io/tags/><i class="fas fa-tags"></i></a></li><div class=tags-sm><li><a href=https://aben20807.github.io/tags/flex role=button class="no-underline no-underline-on-hover">flex</a></li><li><a href=https://aben20807.github.io/tags/bison role=button class="no-underline no-underline-on-hover">bison</a></li><li><a href=https://aben20807.github.io/tags/compiler role=button class="no-underline no-underline-on-hover">compiler</a></li><li><a href=https://aben20807.github.io/tags/lex role=button class="no-underline no-underline-on-hover">lex</a></li><li><a href=https://aben20807.github.io/tags/yacc role=button class="no-underline no-underline-on-hover">yacc</a></li><li><a href=https://aben20807.github.io/tags/jvm role=button class="no-underline no-underline-on-hover">jvm</a></li><li><a href=https://aben20807.github.io/tags/bytecode role=button class="no-underline no-underline-on-hover">bytecode</a></li></div></div></div></div></div><script src=https://code.iconify.design/1/1.0.0-rc6/iconify.min.js></script><p>指令生成 (Codegen)</p><ul><li>Series: <a href=https://aben20807.github.io/posts/20210722-build-a-simple-compiler-with-flex-bison-ep0/ class=self-link>[ep0]</a>, <a href=https://aben20807.github.io/posts/20210722-build-a-simple-compiler-ep1/ class=self-link>[ep1]</a>, <a href=https://aben20807.github.io/posts/20210722-build-a-simple-compiler-ep2/ class=self-link>[ep2]</a>, <a href=https://aben20807.github.io/posts/20210722-build-a-simple-compiler-ep3/ class=self-link>[ep3]</a></li><li>Source code: <a href=https://github.com/aben20807/learn_compiler target=_blank rel="noreferrer noopener">aben20807/learn_compiler</a></li></ul><h1 id=指令生成-codegen class=article-heading>指令生成 (Codegen)<a class="headline-hash smoothScroll hover-show scrollspy" style=font-size:.75em;color:#000;padding-left:.25em href=#指令生成-codegen><span class=iconify data-icon=octicon-link data-inline=false></span></a></h1><p><del>由於是簡化版的編譯器</del>，我們不產生中間的表達式 (Intermediate representation, IR) <sup id=fnref:1><a href=#fn:1 class="footnote-ref smoothScroll no-underline-on-hover" role=doc-noteref>1</a></sup>，也不會有 Abstract syntax tree (AST) <sup id=fnref:2><a href=#fn:2 class="footnote-ref smoothScroll no-underline-on-hover" role=doc-noteref>2</a></sup>，而是直接利用上一篇的螢幕輸出改成對應的 Java bytecode 指令 <sup id=fnref:3><a href=#fn:3 class="footnote-ref smoothScroll no-underline-on-hover" role=doc-noteref>3</a></sup>。有興趣的可以去參考完整列表 <sup id=fnref:4><a href=#fn:4 class="footnote-ref smoothScroll no-underline-on-hover" role=doc-noteref>4</a></sup> 看有支援什麼神奇功能。會寫 Java 的也可以參考如何使用反組譯的方式 <sup id=fnref:5><a href=#fn:5 class="footnote-ref smoothScroll no-underline-on-hover" role=doc-noteref>5</a></sup> 找出對應的 bytecode 來觀察行為。</p><h1 id=jasmin class=article-heading>Jasmin<a class="headline-hash smoothScroll hover-show scrollspy" style=font-size:.75em;color:#000;padding-left:.25em href=#jasmin><span class=iconify data-icon=octicon-link data-inline=false></span></a></h1><p>Jasmin <sup id=fnref:6><a href=#fn:6 class="footnote-ref smoothScroll no-underline-on-hover" role=doc-noteref>6</a></sup> 為一 JVM 的組譯器，其會將可讀指令形式的 bytecode 轉換成 .class 的形式 (可執行的 bytecode)。</p><h2 id=j-檔格式 class=article-heading><code>.j</code> 檔格式<a class="headline-hash smoothScroll hover-show scrollspy" style=font-size:.75em;color:#000;padding-left:.25em href=#j-檔格式><span class=iconify data-icon=octicon-link data-inline=false></span></a></h2><ul><li>開頭及結尾如下，只需要在一開始開檔時就寫入開頭，等到全部指令產生完畢，離開前再寫入結尾即可。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>.source</span> <span style=color:#66d9ef>bytecode.j</span>
<span style=color:#a6e22e>.class</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>Main</span>
<span style=color:#a6e22e>.super</span> <span style=color:#66d9ef>java</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>Object</span>
<span style=color:#a6e22e>.method</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>main</span>([<span style=color:#66d9ef>Ljava</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>String</span><span style=color:#75715e>;)V
</span><span style=color:#75715e></span><span style=color:#66d9ef>.limit</span> <span style=color:#66d9ef>stack</span> <span style=color:#ae81ff>10</span>
<span style=color:#a6e22e>.limit</span> <span style=color:#66d9ef>locals</span> <span style=color:#ae81ff>10</span>
    
    <span style=color:#75715e>; generated instructions
</span><span style=color:#75715e></span>	
    <span style=color:#a6e22e>return</span>
<span style=color:#a6e22e>.end</span> <span style=color:#66d9ef>method</span>

</code></pre></div><h1 id=完整程式碼 class=article-heading>完整程式碼<a class="headline-hash smoothScroll hover-show scrollspy" style=font-size:.75em;color:#000;padding-left:.25em href=#完整程式碼><span class=iconify data-icon=octicon-link data-inline=false></span></a></h1><p>仔細看的話就會發現跟 ep2 的程式碼幾乎差不多，只有加了寫檔把對應操作的指令寫入 bytecode.j。</p><div class="alert error-msg"><i class="fa fa-times-circle"></i>下方程式碼的 symbol table 為求簡單所以使用一維陣列實作，僅適用於本範例，容易造成記憶體錯誤且無法套用至多層級的 scope，所以請勿學習。</div><ul><li><code>mycompiler.y</code>:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*	Definition section */</span>
<span style=color:#f92672>%</span>{
    <span style=color:#75715e>//Extern variables that communicate with lex
</span><span style=color:#75715e></span>    <span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;common.h&#34; </span><span style=color:#75715e>
</span><span style=color:#75715e></span>    <span style=color:#75715e>// #define YYDEBUG 1
</span><span style=color:#75715e></span>    <span style=color:#75715e>// int yydebug = 1;
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>int</span> yylineno;
    <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>yylex</span>();
    <span style=color:#66d9ef>extern</span> FILE <span style=color:#f92672>*</span>yyin;

    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>yyerror</span> (<span style=color:#66d9ef>char</span> <span style=color:#66d9ef>const</span> <span style=color:#f92672>*</span>s)
    {
        printf(<span style=color:#e6db74>&#34;error:%d: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, yylineno, s);
    }

    <span style=color:#75715e>#define codegen(...) \
</span><span style=color:#75715e>        do { \
</span><span style=color:#75715e>            for (int i = 0; i &lt; indent_cnt; i++) { \
</span><span style=color:#75715e>                fprintf(fout, &#34;\t&#34;); \
</span><span style=color:#75715e>            } \
</span><span style=color:#75715e>            fprintf(fout, __VA_ARGS__); \
</span><span style=color:#75715e>        } while (0)
</span><span style=color:#75715e></span>

    <span style=color:#75715e>/* Symbol table function */</span>
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>create_symbol</span>(<span style=color:#75715e>/* ... */</span>);
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert_symbol</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> id_name);
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>lookup_symbol</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> id_name);
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dump_symbol</span>();
    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>get_op_name</span>(op_t op) {
        <span style=color:#66d9ef>switch</span> (op) {
            <span style=color:#66d9ef>case</span> OP_ADD:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;ADD&#34;</span>;
            <span style=color:#66d9ef>case</span> OP_SUB:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;SUB&#34;</span>;
            <span style=color:#66d9ef>case</span> OP_MUL:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;MUL&#34;</span>;
            <span style=color:#66d9ef>case</span> OP_DIV:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;DIV&#34;</span>;
            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;unknown&#34;</span>;
        }
    }
    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>get_op_instruction</span>(op_t op) {
        <span style=color:#66d9ef>switch</span> (op) {
            <span style=color:#66d9ef>case</span> OP_ADD:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;iadd&#34;</span>;
            <span style=color:#66d9ef>case</span> OP_SUB:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;isub&#34;</span>;
            <span style=color:#66d9ef>case</span> OP_MUL:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;imul&#34;</span>;
            <span style=color:#66d9ef>case</span> OP_DIV:
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;idiv&#34;</span>;
            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;unknown&#34;</span>;
        }
    }

    <span style=color:#75715e>/* Global variables */</span>
    <span style=color:#66d9ef>int</span> example_symbol_cnt <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    <span style=color:#75715e>#define MAX_SYMBOL_NUM 10
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>example_symbol[MAX_SYMBOL_NUM] <span style=color:#f92672>=</span> {};
    <span style=color:#66d9ef>int</span> indent_cnt <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// control the number of ident in bytecode
</span><span style=color:#75715e></span>    FILE<span style=color:#f92672>*</span> fout <span style=color:#f92672>=</span> NULL;
<span style=color:#f92672>%</span>}

<span style=color:#f92672>%</span>error<span style=color:#f92672>-</span>verbose

<span style=color:#75715e>/* Use variable or self-defined structure to represent
</span><span style=color:#75715e> * nonterminal and token type
</span><span style=color:#75715e> */</span>
<span style=color:#f92672>%</span><span style=color:#66d9ef>union</span> {
    <span style=color:#66d9ef>int</span> val;
    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>id_name;
    op_t op;
}

<span style=color:#75715e>/* Token without return */</span>
<span style=color:#f92672>%</span>token DECL PRINT NEWLINE

<span style=color:#75715e>/* Token with return, which need to sepcify type */</span>
<span style=color:#f92672>%</span>token <span style=color:#f92672>&lt;</span>val<span style=color:#f92672>&gt;</span> NUMLIT
<span style=color:#f92672>%</span>token <span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span> IDENT

<span style=color:#75715e>/* Nonterminal with return, which need to sepcify type */</span>
<span style=color:#f92672>%</span>type <span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span> AddOp MulOp

<span style=color:#75715e>/* Yacc will start at this nonterminal */</span>
<span style=color:#f92672>%</span>start Program

<span style=color:#75715e>/* Grammar section */</span>
<span style=color:#f92672>%%</span>

Program
    : StatementList
;

StatementList
    : Statement StatementList
    <span style=color:#f92672>|</span>
;

Statement
    : DeclStmt
    <span style=color:#f92672>|</span> PrintStmt
;

DeclStmt
    : DECL IDENT <span style=color:#e6db74>&#39;=&#39;</span> Expression NEWLINE {
        <span style=color:#66d9ef>int</span> ref <span style=color:#f92672>=</span> insert_symbol(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>);
        printf(<span style=color:#e6db74>&#34;IDENT %s, ref: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>, ref);
        printf(<span style=color:#e6db74>&#34;STORE</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        free(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>);
        codegen(<span style=color:#e6db74>&#34;istore %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ref);
    }
;

PrintStmt
    : PRINT Expression NEWLINE {
        printf(<span style=color:#e6db74>&#34;PRINT</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        codegen(<span style=color:#e6db74>&#34;getstatic java/lang/System/out Ljava/io/PrintStream;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        codegen(<span style=color:#e6db74>&#34;swap</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        codegen(<span style=color:#e6db74>&#34;invokevirtual java/io/PrintStream/print(I)V</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    }
;

Expression
    : AddExpr
;

AddExpr
    : AddExpr AddOp MulExpr {
        printf(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, get_op_name(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>));
        codegen(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, get_op_instruction(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>));
    }
    <span style=color:#f92672>|</span> MulExpr
;

AddOp
    : <span style=color:#e6db74>&#39;+&#39;</span>  {
        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#f92672>=</span> OP_ADD;
    }
    <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;-&#39;</span> {
        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#f92672>=</span> OP_SUB;
    }
;

MulExpr
    : MulExpr MulOp Operand {
        printf(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, get_op_name(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>));
        codegen(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, get_op_instruction(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span>));
    }
    <span style=color:#f92672>|</span> Operand
;

MulOp
    : <span style=color:#e6db74>&#39;*&#39;</span> {
        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#f92672>=</span> OP_MUL;
    }
    <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;/&#39;</span> {
        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>op<span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#f92672>=</span> OP_DIV;
    }
;

Operand
    : NUMLIT {
        printf(<span style=color:#e6db74>&#34;NUMLIT %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>val<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>);
        codegen(<span style=color:#e6db74>&#34;ldc %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>val<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>);
    }
    <span style=color:#f92672>|</span> IDENT {
        <span style=color:#66d9ef>int</span> ref <span style=color:#f92672>=</span> lookup_symbol(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>);
        printf(<span style=color:#e6db74>&#34;IDENT %s, ref: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>, ref);
        printf(<span style=color:#e6db74>&#34;LOAD</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        free(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>&lt;</span>id_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>);
        codegen(<span style=color:#e6db74>&#34;iload %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ref);
    }
    <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;(&#39;</span> Expression <span style=color:#e6db74>&#39;)&#39;</span>
;


<span style=color:#f92672>%%</span>

<span style=color:#75715e>/* C code section */</span>
<span style=color:#66d9ef>int</span> main(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
{
    <span style=color:#66d9ef>if</span> (argc <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>) {
        yyin <span style=color:#f92672>=</span> fopen(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;r&#34;</span>);
    } <span style=color:#66d9ef>else</span> {
        yyin <span style=color:#f92672>=</span> stdin;
    }

    <span style=color:#75715e>/* Codegen output init */</span>
    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>bytecode_filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bytecode.j&#34;</span>;
    fout <span style=color:#f92672>=</span> fopen(bytecode_filename, <span style=color:#e6db74>&#34;w&#34;</span>);
    codegen(<span style=color:#e6db74>&#34;.source bytecode.j</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    codegen(<span style=color:#e6db74>&#34;.class public Main</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    codegen(<span style=color:#e6db74>&#34;.super java/lang/Object</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    codegen(<span style=color:#e6db74>&#34;.method public static main([Ljava/lang/String;)V</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    codegen(<span style=color:#e6db74>&#34;.limit stack 10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    codegen(<span style=color:#e6db74>&#34;.limit locals 10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    indent_cnt<span style=color:#f92672>++</span>;

    create_symbol();
    yyparse();
    dump_symbol();

    <span style=color:#75715e>/* Codegen end */</span>
    codegen(<span style=color:#e6db74>&#34;return</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    indent_cnt<span style=color:#f92672>--</span>;
    codegen(<span style=color:#e6db74>&#34;.end method</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    fclose(fout);
    fclose(yyin);
    printf(<span style=color:#e6db74>&#34;Total lines: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, yylineno);
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> create_symbol()
{
    printf(<span style=color:#e6db74>&#34;&gt; Create symbol table</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    <span style=color:#75715e>// do nothing...
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> insert_symbol(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> id_name)
{
    printf(<span style=color:#e6db74>&#34;&gt; Insert {%s} into symbol table; assign it as ref {%d}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, 
        id_name, example_symbol_cnt);
    example_symbol[example_symbol_cnt] <span style=color:#f92672>=</span> strdup(id_name);
    example_symbol_cnt<span style=color:#f92672>++</span>;
    <span style=color:#66d9ef>return</span> example_symbol_cnt <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> lookup_symbol(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> id_name)
{
    printf(<span style=color:#e6db74>&#34;&gt; Lookup in symbol table</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> example_symbol_cnt; i<span style=color:#f92672>++</span>) {
        <span style=color:#66d9ef>if</span> (strcmp(id_name, example_symbol[i]) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
            <span style=color:#66d9ef>return</span> i;
        }
    }
    printf(<span style=color:#e6db74>&#34;{%s} not found in symbol table</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, id_name);
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
}
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> dump_symbol()
{
    printf(<span style=color:#e6db74>&#34;&gt; Dump symbol table</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> example_symbol_cnt; i<span style=color:#f92672>++</span>) {
        free(example_symbol[i]);
    }
}
</code></pre></div><h1 id=測試範例 class=article-heading>測試範例<a class="headline-hash smoothScroll hover-show scrollspy" style=font-size:.75em;color:#000;padding-left:.25em href=#測試範例><span class=iconify data-icon=octicon-link data-inline=false></span></a></h1><ul><li><code>input/in01.lc</code>:</li></ul><pre><code>decl x = 1 + 4
decl y = 2
decl num = x + y * (3 + 5)
print num
</code></pre><ul><li>Result (其他檔案，如 Makefile 請參考 Source code):</li></ul><pre><code>$ make
$ ./mycompiler &lt; input/in01.lc
$ java -jar jasmin.jar -g bytecode.j
Generated: Main.class
$ java Main
21
</code></pre><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/Intermediate_representation target=_blank rel="noreferrer noopener">https://en.wikipedia.org/wiki/Intermediate_representation</a> <sup><a href=#fnref:1 class="smoothScroll footnote-backref no-underline-on-hover" role=doc-backlink>&#8617;&#xfe0e;</a></sup></p></li><li id=fn:2 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/Abstract_syntax_tree target=_blank rel="noreferrer noopener">https://en.wikipedia.org/wiki/Abstract_syntax_tree</a> <sup><a href=#fnref:2 class="smoothScroll footnote-backref no-underline-on-hover" role=doc-backlink>&#8617;&#xfe0e;</a></sup></p></li><li id=fn:3 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/Java_bytecode target=_blank rel="noreferrer noopener">https://en.wikipedia.org/wiki/Java_bytecode</a> <sup><a href=#fnref:3 class="smoothScroll footnote-backref no-underline-on-hover" role=doc-backlink>&#8617;&#xfe0e;</a></sup></p></li><li id=fn:4 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings target=_blank rel="noreferrer noopener">Java bytecode instruction listings</a> <sup><a href=#fnref:4 class="smoothScroll footnote-backref no-underline-on-hover" role=doc-backlink>&#8617;&#xfe0e;</a></sup></p></li><li id=fn:5 role=doc-endnote><p><a href=https://github.com/aben20807/blog-post/issues/105 target=_blank rel="noreferrer noopener">https://github.com/aben20807/blog-post/issues/105</a> <sup><a href=#fnref:5 class="smoothScroll footnote-backref no-underline-on-hover" role=doc-backlink>&#8617;&#xfe0e;</a></sup></p></li><li id=fn:6 role=doc-endnote><p><a href=http://jasmin.sourceforge.net/guide.html>http://jasmin.sourceforge.net/guide.html</a> <sup><a href=#fnref:6 class="smoothScroll footnote-backref no-underline-on-hover" role=doc-backlink>&#8617;&#xfe0e;</a></sup></p></li></ol></section>Last modified: Jul 26, 2021<div class=row><script type=text/javascript>document.write("<iframe scrolling='no' frameborder='0' class='center' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='' src='https://button.like.co/in/embed/aben20807/button?referrer="+encodeURIComponent(location.href.split("?")[0].split("#")[0])+"'></iframe>");</script></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"forrecording"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><div id=toc class="column col-2 hide-print"><div class="toc toc-nav toc-pills ml-0 col-3"><li class="nav-item pb-3 text-center"><span class="font-weight-bold mb-2">- CATALOG -</span></li><div id=toc-scroll class="noselect hide-scrollbar"><ul class=toc><li class=toc-item><a class="toc-link smoothScroll" href=#%e6%8c%87%e4%bb%a4%e7%94%9f%e6%88%90-codegen>指令生成 (Codegen)</a></li></ul><ul class=toc><li class=toc-item><a class="toc-link smoothScroll" href=#jasmin>Jasmin</a></li></ul><ul class=toc><ul class=toc><li class=toc-item><a class="toc-link smoothScroll" href=#j-%e6%aa%94%e6%a0%bc%e5%bc%8f>.j 檔格式</a></li></ul></ul><ul class=toc><li class=toc-item><a class="toc-link smoothScroll" href=#%e5%ae%8c%e6%95%b4%e7%a8%8b%e5%bc%8f%e7%a2%bc>完整程式碼</a></li></ul><ul class=toc><li class=toc-item><a class="toc-link smoothScroll" href=#%e6%b8%ac%e8%a9%a6%e7%af%84%e4%be%8b>測試範例</a></li></ul></div><ul class=toc><li class=toc-item><a class="goto pl1 toc-item" id=gotop>⊛ Back to top</a></li><li class=toc-item><a class="goto pl1 toc-item" id=gobottom>⊛ Go to bottom</a></li><script type=text/javascript>fetchInject(["https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"]).then(()=>{var url="https://cdnjs.cloudflare.com/ajax/libs/jquery-smooth-scroll/2.2.0/jquery.smooth-scroll.min.js";$.getScript(url,function(){$("#gotop").click(function(event){$('html,body').animate({scrollTop:0},300,'swing',function(){$('a.toc-link').removeClass('active');});});$("#gobottom").click(function(event){$('html,body').animate({scrollTop:$(document).height()},300,'swing',function(){$('a.toc-link').removeClass('active');});});});});</script></ul></div></div></div></main><footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3 db overflow-auto" role=contentinfo><p class="w-50 fr tr" style=font-size:.875rem!important>Made with Hugo and
<a class="no-underline no-underline-on-hover" href=https://github.com/aben20807/hugOuO target=_blank rel="noreferrer noopener">hugOuO</a></p><p class="w-50 near-white" style=font-size:.875rem!important>&copy; 2019-2021 Huang Po-Hsuan</p></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js></script><script type=text/javascript src=https://aben20807.github.io/js/hugouo.js async></script><script src=https://aben20807.github.io/js/story.js async></script><script>fetchInject(["https://cdn.jsdelivr.net/npm/baffle@0.3.6/dist/baffle.min.js"]).then(()=>{baffle(document.querySelector('h1')).start().set({speed:70,}).reveal(800,800);});</script><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
      inlineMath: [['$','$']],
      displayMath: [['$$','$$']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
          extensions: ["AMSmath.js", "AMSsymbols.js"] }
      }
    });
  </script><script src=https://unpkg.com/zooming/build/zooming.min.js></script><script>document.addEventListener('DOMContentLoaded',function(){new Zooming({bgColor:'rgb(0, 0, 0)',bgOpacity:'0.8',customSize:'200%',enableGrab:false}).listen('.img-zoomable')})</script></body></html>